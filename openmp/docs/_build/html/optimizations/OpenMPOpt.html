<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>OpenMP-Aware Optimizations &#8212; LLVM/OpenMP  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/agogo.css?v=a323ad78" />
    <script src="../_static/documentation_options.js?v=7f41d439"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OpenMP-Unaware Optimizations" href="OpenMPUnawareOptimizations.html" />
    <link rel="prev" title="OpenMP Optimizations in LLVM" href="Overview.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">LLVM/OpenMP  documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../index.html" title="LLVM OpenMP Documentation">HOME</a>
           |
          <a href="Overview.html" title="OpenMP Optimizations in LLVM"
             accesskey="P">previous</a> |
          <a href="OpenMPUnawareOptimizations.html" title="OpenMP-Unaware Optimizations"
             accesskey="N">next</a> |
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="openmp-aware-optimizations">
<h1>OpenMP-Aware Optimizations<a class="headerlink" href="#openmp-aware-optimizations" title="Link to this heading">¶</a></h1>
<p>LLVM, since <a class="reference external" href="https://releases.llvm.org/download.html#11.0.0">version 11</a> (12
Oct 2020), supports an <a class="reference internal" href="#openmpopt"><span class="std std-ref">OpenMP-Aware optimization pass</span></a>. This
optimization pass will attempt to optimize the module with OpenMP-specific
domain-knowledge. This pass is enabled by default at high optimization levels
(O2 / O3) if compiling with OpenMP support enabled.</p>
<section id="openmpopt">
<span id="id1"></span><h2>OpenMPOpt<a class="headerlink" href="#openmpopt" title="Link to this heading">¶</a></h2>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#openmp-runtime-call-deduplication" id="id2">OpenMP Runtime Call Deduplication</a></p></li>
<li><p><a class="reference internal" href="#globalization" id="id3">Globalization</a></p></li>
</ul>
</nav>
<p>OpenMPOpt contains several OpenMP-Aware optimizations. This pass is run early on
the entire Module, and later on the entire call graph. Most optimizations done
by OpenMPOpt support remarks. Optimization remarks can be enabled by compiling
with the following flags.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang<span class="w"> </span>-Rpass<span class="o">=</span>openmp-opt<span class="w"> </span>-Rpass-missed<span class="o">=</span>openmp-opt<span class="w"> </span>-Rpass-analysis<span class="o">=</span>openmp-opt
</pre></div>
</div>
<section id="openmp-runtime-call-deduplication">
<h3><a class="toc-backref" href="#id2" role="doc-backlink">OpenMP Runtime Call Deduplication</a><a class="headerlink" href="#openmp-runtime-call-deduplication" title="Link to this heading">¶</a></h3>
<p>The OpenMP runtime library contains several functions used to implement features
of the OpenMP standard. Several of the runtime calls are constant within a
parallel region. A common optimization is to replace invariant code with a
single reference, but in this case the compiler will only see an opaque call
into the runtime library. To get around this, OpenMPOpt maintains a list of
OpenMP runtime functions that are constant and will manually deduplicate them.</p>
</section>
<section id="globalization">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Globalization</a><a class="headerlink" href="#globalization" title="Link to this heading">¶</a></h3>
<p>The OpenMP standard requires that data can be shared between different threads.
This requirement poses a unique challenge when offloading to GPU accelerators.
Data cannot be shared between the threads in a GPU by default, in order to do
this it must either be placed in global or shared memory. This needs to be done
every time a variable may potentially be shared in order to create correct
OpenMP programs. Unfortunately, this has significant performance implications
and is not needed in the majority of cases. For example, when Clang is
generating code for this offloading region, it will see that the variable <cite>x</cite>
escapes and is potentially shared. This will require globalizing the variable,
which means it cannot reside in the registers on the device.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">  </span><span class="n">use</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#pragma omp target parallel</span>
<span class="w">  </span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In many cases, this transformation is not actually necessary but still carries a
significant performance penalty. Because of this, OpenMPOpt can perform and
inter-procedural optimization and scan each known usage of the globalized
variable and determine if it is potentially captured and shared by another
thread. If it is not actually captured, it can safely be moved back to fast
register memory.</p>
<p>Another case is memory that is intentionally shared between the threads, but is
shared from one thread to all the others. Such variables can be moved to shared
memory when compiled without needing to go through the runtime library.  This
allows for users to confidently declare shared memory on the device without
needing to use custom OpenMP allocators or rely on the runtime.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">share</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="cp">#pragma omp parallel</span>
<span class="w">  </span><span class="n">share</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cp">#pragma omp target</span>
<span class="w">  </span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These optimizations can have very large performance implications. Both of these
optimizations rely heavily on inter-procedural analysis. Because of this,
offloading applications should ideally be contained in a single translation unit
and functions should not be externally visible unless needed. OpenMPOpt will
inform the user if any globalization calls remain if remarks are enabled. This
should be treated as a defect in the program.</p>
</section>
</section>
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>2021 OpenMP Webinar: “A Compiler’s View of OpenMP” <a class="reference external" href="https://youtu.be/eIMpgez61r4">https://youtu.be/eIMpgez61r4</a></p></li>
<li><p>2020 LLVM Developers’ Meeting: “(OpenMP) Parallelism-Aware Optimizations” <a class="reference external" href="https://youtu.be/gtxWkeLCxmU">https://youtu.be/gtxWkeLCxmU</a></p></li>
<li><p>2019 EuroLLVM Developers’ Meeting: “Compiler Optimizations for (OpenMP) Target Offloading to GPUs” <a class="reference external" href="https://youtu.be/3AbS82C3X30">https://youtu.be/3AbS82C3X30</a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">LLVM/OpenMP Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/Overview.html">OpenMP in LLVM — Design Overview</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../openacc/Overview.html">OpenACC Support</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="Overview.html">OpenMP Optimizations in LLVM</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">OpenMP-Aware Optimizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="OpenMPUnawareOptimizations.html">OpenMP-Unaware Optimizations</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../remarks/OptimizationRemarks.html">OpenMP Optimization Remarks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CommandLineArgumentReference.html">OpenMP Command-Line Argument Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../SupportAndFAQ.html">Support, Getting Involved, and FAQ</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ReleaseNotes.html">In-Progress ReleaseNotes</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </div>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../index.html" title="LLVM OpenMP Documentation">HOME</a>
             |
            <a href="Overview.html" title="OpenMP Optimizations in LLVM"
              >previous</a> |
            <a href="OpenMPUnawareOptimizations.html" title="OpenMP-Unaware Optimizations"
              >next</a> |
            <a href="../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013-2025, LLVM/OpenMP.
      Last updated on 2025-08-13.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>