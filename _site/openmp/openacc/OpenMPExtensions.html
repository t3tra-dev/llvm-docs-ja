<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>OpenMP Extensions for OpenACC &#8212; LLVM/OpenMP  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/agogo.css?v=a323ad78" />
    <script src="../_static/documentation_options.js?v=7f41d439"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OpenMP Optimizations in LLVM" href="../optimizations/Overview.html" />
    <link rel="prev" title="OpenACC Support" href="Overview.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">LLVM/OpenMP  documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../index.html" title="LLVM OpenMP Documentation">HOME</a>
           |
          <a href="Overview.html" title="OpenACC Support"
             accesskey="P">previous</a> |
          <a href="../optimizations/Overview.html" title="OpenMP Optimizations in LLVM"
             accesskey="N">next</a> |
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="openmp-extensions-for-openacc">
<h1>OpenMP Extensions for OpenACC<a class="headerlink" href="#openmp-extensions-for-openacc" title="Link to this heading">¶</a></h1>
<p>OpenACC provides some functionality that OpenMP does not.  In some
cases, Clang supports OpenMP extensions to provide similar
functionality, taking advantage of the runtime implementation already
required for OpenACC.  This section documents those extensions.</p>
<p>By default, Clang recognizes these extensions.  The command-line
option <code class="docutils literal notranslate"><span class="pre">-fno-openmp-extensions</span></code> can be specified to disable all
OpenMP extensions, including those described in this section.</p>
<section id="motivation">
<span id="ompx-motivation"></span><h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">¶</a></h2>
<p>There are multiple benefits to exposing OpenACC functionality as LLVM
OpenMP extensions:</p>
<ul class="simple">
<li><p>OpenMP applications can take advantage of the additional
functionality.</p></li>
<li><p>As LLVM’s implementation of these extensions matures, it can serve
as a basis for including these extensions in the OpenMP standard.</p></li>
<li><p>Source-to-source translation from certain OpenACC features to OpenMP
is otherwise impossible.</p></li>
<li><p>Runtime tests can be written in terms of OpenMP instead of OpenACC
or low-level runtime calls.</p></li>
<li><p>More generally, there is a clean separation of concerns between
OpenACC and OpenMP development in LLVM.  That is, LLVM’s OpenMP
developers can discuss, modify, and debug LLVM’s extended OpenMP
implementation and test suite without directly considering OpenACC’s
language and execution model, which are handled by LLVM’s OpenACC
developers.</p></li>
</ul>
</section>
<section id="ompx-hold-map-type-modifier">
<span id="ompx-hold"></span><h2><code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> Map Type Modifier<a class="headerlink" href="#ompx-hold-map-type-modifier" title="Link to this heading">¶</a></h2>
<section id="example">
<span id="ompx-holdexample"></span><h3>Example<a class="headerlink" href="#example" title="Link to this heading">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target data map(ompx_hold, tofrom: x) </span><span class="c1">// holds onto mapping of x throughout region</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">foo</span><span class="p">();</span><span class="w"> </span><span class="c1">// might have map(delete: x)</span>
<span class="w">  </span><span class="cp">#pragma omp target map(present, alloc: x) </span><span class="c1">// x is guaranteed to be present</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type modifier above specifies that the <code class="docutils literal notranslate"><span class="pre">target</span>
<span class="pre">data</span></code> directive holds onto the mapping for <code class="docutils literal notranslate"><span class="pre">x</span></code> throughout the
associated region regardless of any <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">exit</span> <span class="pre">data</span></code> directives
executed during the call to <code class="docutils literal notranslate"><span class="pre">foo</span></code>.  Thus, the presence assertion for
<code class="docutils literal notranslate"><span class="pre">x</span></code> at the enclosed <code class="docutils literal notranslate"><span class="pre">target</span></code> construct cannot fail.</p>
</section>
<section id="behavior">
<span id="ompx-holdbehavior"></span><h3>Behavior<a class="headerlink" href="#behavior" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Stated more generally, the <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type modifier specifies
that the associated data is not unmapped until the end of the
construct.  As usual, the standard OpenMP reference count for the
data must also reach zero before the data is unmapped.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> is specified for the same data on lexically or
dynamically enclosed constructs, there is no additional effect as
the data mapping is already held throughout their regions.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type modifier is permitted to appear only on
<code class="docutils literal notranslate"><span class="pre">target</span></code> constructs (and associated combined constructs) and
<code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">data</span></code> constructs.  It is not permitted to appear on
<code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">enter</span> <span class="pre">data</span></code> or <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">exit</span> <span class="pre">data</span></code> directives because
there is no associated statement, so it is not meaningful to hold
onto a mapping until the end of the directive.</p></li>
<li><p>The runtime reports an error if <code class="docutils literal notranslate"><span class="pre">omp_target_disassociate_ptr</span></code> is
called for a mapping for which the <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type modifier
is in effect.</p></li>
<li><p>Like the <code class="docutils literal notranslate"><span class="pre">present</span></code> map type modifier, the <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type
modifier applies to an entire struct if it’s specified for any
member of that struct even if other <code class="docutils literal notranslate"><span class="pre">map</span></code> clauses on the same
directive specify other members without the <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type
modifier.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> support is not yet provided for <code class="docutils literal notranslate"><span class="pre">defaultmap</span></code>.</p></li>
</ul>
</section>
<section id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>LLVM uses the term <em>dynamic reference count</em> for the standard OpenMP
reference count for host/device data mappings.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type modifier selects an alternate reference
count, called the <em>hold reference count</em>.</p></li>
<li><p>A mapping is removed only once both its reference counts reach zero.</p></li>
<li><p>Because <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> can appear only constructs, increments and
decrements of the hold reference count are guaranteed to be
balanced, so it is impossible to decrement it below zero.</p></li>
<li><p>The dynamic reference count is used wherever <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> is not
specified (and possibly cannot be specified).  Decrementing the
dynamic reference count has no effect if it is already zero.</p></li>
<li><p>The runtime determines that the <code class="docutils literal notranslate"><span class="pre">ompx_hold</span></code> map type modifier is
<em>in effect</em> (see <a class="reference internal" href="#ompx-holdbehavior"><span class="std std-ref">Behavior</span></a> above) when the
hold reference count is greater than zero.</p></li>
</ul>
</section>
<section id="relationship-with-openacc">
<h3>Relationship with OpenACC<a class="headerlink" href="#relationship-with-openacc" title="Link to this heading">¶</a></h3>
<p>OpenACC specifies two reference counts for tracking host/device data
mappings.  Which reference count is used to implement an OpenACC
directive is determined by the nature of that directive, either
dynamic or structured:</p>
<ul class="simple">
<li><p>The <em>dynamic reference count</em> is always used for <code class="docutils literal notranslate"><span class="pre">enter</span> <span class="pre">data</span></code> and
<code class="docutils literal notranslate"><span class="pre">exit</span> <span class="pre">data</span></code> directives and corresponding OpenACC routines.</p></li>
<li><p>The <em>structured reference count</em> is always used for <code class="docutils literal notranslate"><span class="pre">data</span></code> and
compute constructs, which are similar to OpenMP’s <code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">data</span></code>
and <code class="docutils literal notranslate"><span class="pre">target</span></code> constructs.</p></li>
</ul>
<p>Contrast with OpenMP, where the dynamic reference count is always used
unless the application developer specifies an alternate behavior via
our map type modifier extension.  We chose the name <em>hold</em> for that
map type modifier because, as demonstrated in the above <a class="reference internal" href="#ompx-holdexample"><span class="std std-ref">example</span></a>, <em>hold</em> concisely identifies the desired behavior
from the application developer’s perspective without referencing the
implementation of that behavior.</p>
<p>The hold reference count is otherwise modeled after OpenACC’s
structured reference count.  For example, calling <code class="docutils literal notranslate"><span class="pre">acc_unmap_data</span></code>,
which is similar to <code class="docutils literal notranslate"><span class="pre">omp_target_disassociate_ptr</span></code>, is an error when
the structured reference count is not zero.</p>
<p>While Flang and Clang obviously must implement the syntax and
semantics for selecting OpenACC reference counts differently than for
selecting OpenMP reference counts, the implementation is the same at
the runtime level.  That is, OpenACC’s dynamic reference count is
OpenMP’s dynamic reference count, and OpenACC’s structured reference
count is our OpenMP hold reference count extension.</p>
</section>
</section>
<section id="atomic-strictly-nested-within-teams">
<span id="atomicwithinteams"></span><h2><code class="docutils literal notranslate"><span class="pre">atomic</span></code> Strictly Nested Within <code class="docutils literal notranslate"><span class="pre">teams</span></code><a class="headerlink" href="#atomic-strictly-nested-within-teams" title="Link to this heading">¶</a></h2>
<section id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>OpenMP 5.2, sec. 10.2 “teams Construct”, p. 232, L9-12 restricts what
regions can be strictly nested within a <code class="docutils literal notranslate"><span class="pre">teams</span></code> region.  As an
extension, Clang relaxes that restriction in the case of the
<code class="docutils literal notranslate"><span class="pre">atomic</span></code> construct so that, for example, the following case is
permitted:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp target teams map(tofrom:x)</span>
<span class="cp">#pragma omp atomic update</span>
<span class="n">x</span><span class="o">++</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Relationship with OpenACC<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>This extension is important when translating OpenACC to OpenMP because
OpenACC does not have the same restriction for its corresponding
constructs.  For example, the following is conforming OpenACC:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma acc parallel copy(x)</span>
<span class="cp">#pragma acc atomic update</span>
<span class="n">x</span><span class="o">++</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">LLVM/OpenMP Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/Overview.html">OpenMP in LLVM — Design Overview</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="Overview.html">OpenACC Support</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">OpenMP Extensions for OpenACC</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimizations/Overview.html">OpenMP Optimizations in LLVM</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../remarks/OptimizationRemarks.html">OpenMP Optimization Remarks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CommandLineArgumentReference.html">OpenMP Command-Line Argument Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../SupportAndFAQ.html">Support, Getting Involved, and FAQ</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ReleaseNotes.html">In-Progress ReleaseNotes</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </div>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../index.html" title="LLVM OpenMP Documentation">HOME</a>
             |
            <a href="Overview.html" title="OpenACC Support"
              >previous</a> |
            <a href="../optimizations/Overview.html" title="OpenMP Optimizations in LLVM"
              >next</a> |
            <a href="../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013-2025, LLVM/OpenMP.
      Last updated on 2025-08-13.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>