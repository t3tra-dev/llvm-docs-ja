<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Testing the GPU C library &#8212; The LLVM C Library</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=2e637bd6" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Motivation and Limitations" href="motivation.html" />
    <link rel="prev" title="Remote Procedure Calls" href="rpc.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="testing-the-gpu-c-library">
<span id="libc-gpu-testing"></span><h1>Testing the GPU C library<a class="headerlink" href="#testing-the-gpu-c-library" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Running GPU tests with high parallelism is likely to cause spurious failures,
out of resource errors, or indefinite hangs. limiting the number of threads
used while testing using <code class="docutils literal notranslate"><span class="pre">LIBC_GPU_TEST_JOBS=&lt;N&gt;</span></code> is highly recommended.</p>
</div>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#testing-infrastructure" id="id1">Testing infrastructure</a></p></li>
<li><p><a class="reference internal" href="#testing-utilities" id="id2">Testing utilities</a></p>
<ul>
<li><p><a class="reference internal" href="#startup-object" id="id3">Startup object</a></p></li>
<li><p><a class="reference internal" href="#loader-runtime" id="id4">Loader runtime</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#running-tests" id="id5">Running tests</a></p></li>
</ul>
</nav>
<section id="testing-infrastructure">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Testing infrastructure</a><a class="headerlink" href="#testing-infrastructure" title="Link to this heading">¶</a></h2>
<p>The LLVM C library supports different kinds of <a class="reference internal" href="../build_and_test.html#build-and-test"><span class="std std-ref">tests</span></a>
depending on the build configuration. The GPU target is considered a full build
and therefore provides all of its own utilities to build and run the generated
tests. Currently the GPU supports two kinds of tests.</p>
<ol class="arabic simple">
<li><p><strong>Hermetic tests</strong> - These are unit tests built with a test suite similar to
Google’s <code class="docutils literal notranslate"><span class="pre">gtest</span></code> infrastructure. These use the same infrastructure as unit
tests except that the entire environment is self-hosted. This allows us to
run them on the GPU using our custom utilities. These are used to test the
majority of functional implementations.</p></li>
<li><p><strong>Integration tests</strong> - These are lightweight tests that simply call a
<code class="docutils literal notranslate"><span class="pre">main</span></code> function and checks if it returns non-zero. These are primarily used
to test interfaces that are sensitive to threading.</p></li>
</ol>
<p>The GPU uses the same testing infrastructure as the other supported <code class="docutils literal notranslate"><span class="pre">libc</span></code>
targets. We do this by treating the GPU as a standard hosted environment capable
of launching a <code class="docutils literal notranslate"><span class="pre">main</span></code> function. Effectively, this means building our own
startup libraries and loader.</p>
</section>
<section id="testing-utilities">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Testing utilities</a><a class="headerlink" href="#testing-utilities" title="Link to this heading">¶</a></h2>
<p>We provide two utilities to execute arbitrary programs on the GPU. That is the
<code class="docutils literal notranslate"><span class="pre">loader</span></code> and the <code class="docutils literal notranslate"><span class="pre">start</span></code> object.</p>
<section id="startup-object">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Startup object</a><a class="headerlink" href="#startup-object" title="Link to this heading">¶</a></h3>
<p>This object mimics the standard object used by existing C library
implementations. Its job is to perform the necessary setup prior to calling the
<code class="docutils literal notranslate"><span class="pre">main</span></code> function. In the GPU case, this means exporting GPU kernels that will
perform the necessary operations. Here we use <code class="docutils literal notranslate"><span class="pre">_begin</span></code> and <code class="docutils literal notranslate"><span class="pre">_end</span></code> to handle
calling global constructors and destructors while <code class="docutils literal notranslate"><span class="pre">_start</span></code> begins the standard
execution. The following code block shows the implementation for AMDGPU
architectures.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">[[</span><span class="n">gnu</span><span class="o">::</span><span class="n">visibility</span><span class="p">(</span><span class="s">&quot;protected&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">clang</span><span class="o">::</span><span class="n">amdgpu_kernel</span><span class="p">]]</span><span class="w"> </span><span class="kt">void</span>
<span class="n">_begin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">LIBC_NAMESPACE</span><span class="o">::</span><span class="n">atexit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LIBC_NAMESPACE</span><span class="o">::</span><span class="n">call_fini_array_callbacks</span><span class="p">);</span>
<span class="w">  </span><span class="n">LIBC_NAMESPACE</span><span class="o">::</span><span class="n">call_init_array_callbacks</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">[[</span><span class="n">gnu</span><span class="o">::</span><span class="n">visibility</span><span class="p">(</span><span class="s">&quot;protected&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">clang</span><span class="o">::</span><span class="n">amdgpu_kernel</span><span class="p">]]</span><span class="w"> </span><span class="kt">void</span>
<span class="n">_start</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">envp</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">__atomic_fetch_or</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">envp</span><span class="p">),</span><span class="w"> </span><span class="n">__ATOMIC_RELAXED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">[[</span><span class="n">gnu</span><span class="o">::</span><span class="n">visibility</span><span class="p">(</span><span class="s">&quot;protected&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">clang</span><span class="o">::</span><span class="n">amdgpu_kernel</span><span class="p">]]</span><span class="w"> </span><span class="kt">void</span>
<span class="n">_end</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">retval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">LIBC_NAMESPACE</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="loader-runtime">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Loader runtime</a><a class="headerlink" href="#loader-runtime" title="Link to this heading">¶</a></h3>
<p>The startup object provides a GPU executable with callable kernels for the
respective runtime. We can then define a minimal runtime that will launch these
kernels on the given device. Currently we provide the <code class="docutils literal notranslate"><span class="pre">amdhsa-loader</span></code> and
<code class="docutils literal notranslate"><span class="pre">nvptx-loader</span></code> targeting the AMD HSA runtime and CUDA driver runtime
respectively. By default these will launch with a single thread on the GPU.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$&gt;<span class="w"> </span>clang++<span class="w"> </span>crt1.o<span class="w"> </span>test.cpp<span class="w"> </span>--target<span class="o">=</span>amdgcn-amd-amdhsa<span class="w"> </span>-mcpu<span class="o">=</span>native<span class="w"> </span>-flto
$&gt;<span class="w"> </span>amdhsa_loader<span class="w"> </span>--threads<span class="w"> </span><span class="m">1</span><span class="w"> </span>--blocks<span class="w"> </span><span class="m">1</span><span class="w"> </span>./a.out
Test<span class="w"> </span>Passed!
</pre></div>
</div>
<p>The loader utility will forward any arguments passed after the executable image
to the program on the GPU as well as any set environment variables. The number
of threads and blocks to be set can be controlled with <code class="docutils literal notranslate"><span class="pre">--threads</span></code> and
<code class="docutils literal notranslate"><span class="pre">--blocks</span></code>. These also accept additional <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code> variants for
multidimensional grids.</p>
</section>
</section>
<section id="running-tests">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Running tests</a><a class="headerlink" href="#running-tests" title="Link to this heading">¶</a></h2>
<p>Tests will only be built and run if a GPU target architecture is set and the
corresponding loader utility was built. These can be overridden with the
<code class="docutils literal notranslate"><span class="pre">LIBC_GPU_TEST_ARCHITECTURE</span></code> and <code class="docutils literal notranslate"><span class="pre">LIBC_GPU_LOADER_EXECUTABLE</span></code> <a class="reference internal" href="building.html#gpu-cmake-options"><span class="std std-ref">CMake
options</span></a>. Once built, they can be run like any other tests.
The CMake target depends on how the library was built.</p>
<ol class="arabic">
<li><p><strong>Cross build</strong> - If the C library was built using <code class="docutils literal notranslate"><span class="pre">LLVM_ENABLE_PROJECTS</span></code>
or a runtimes cross build, then the standard targets will be present in the
base CMake build directory.</p>
<ol class="arabic">
<li><p>All tests - You can run all supported tests with the command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$&gt;<span class="w"> </span>ninja<span class="w"> </span>check-libc
</pre></div>
</div>
</li>
<li><p>Hermetic tests - You can run hermetic with tests the command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$&gt;<span class="w"> </span>ninja<span class="w"> </span>libc-hermetic-tests
</pre></div>
</div>
</li>
<li><p>Integration tests - You can run integration tests by the command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$&gt;<span class="w"> </span>ninja<span class="w"> </span>libc-integration-tests
</pre></div>
</div>
</li>
</ol>
</li>
<li><p><strong>Runtimes build</strong> - If the library was built using <code class="docutils literal notranslate"><span class="pre">LLVM_ENABLE_RUNTIMES</span></code>
then the actual <code class="docutils literal notranslate"><span class="pre">libc</span></code> build will be in a separate directory.</p>
<ol class="arabic">
<li><p>All tests - You can run all supported tests with the command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$&gt;<span class="w"> </span>ninja<span class="w"> </span>check-libc-amdgcn-amd-amdhsa
$&gt;<span class="w"> </span>ninja<span class="w"> </span>check-libc-nvptx64-nvidia-cuda
</pre></div>
</div>
</li>
<li><p>Specific tests - You can use the same targets as above by entering the
runtimes build directory.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$&gt;<span class="w"> </span>ninja<span class="w"> </span>-C<span class="w"> </span>runtimes/runtimes-amdgcn-amd-amdhsa-bins<span class="w"> </span>check-libc
$&gt;<span class="w"> </span>ninja<span class="w"> </span>-C<span class="w"> </span>runtimes/runtimes-nvptx64-nvidia-cuda-bins<span class="w"> </span>check-libc
$&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>runtimes/runtimes-amdgcn-amd-amdhsa-bins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ninja<span class="w"> </span>check-libc
$&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>runtimes/runtimes-nvptx64-nvidia-cuda-bins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ninja<span class="w"> </span>check-libc
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
<p>Tests can also be built and run manually using the respective loader utility.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">libc</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Status &amp; Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../headers/index.html">Implementation Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch_support.html">Architecture Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platform_support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler_support.html">Compiler Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Simple Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../full_host_build.html">Full Host Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../full_cross_build.html">Full Cross Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overlay_mode.html">Overlay Mode</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">libc for GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uefi/index.html">libc for UEFI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configure.html">Configure Options</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Maintainers.html">LLVM-libc Maintainers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_and_test.html">Building and Testing the libc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting.html">Bringup on a New OS or Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to the libc Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Useful Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../talks.html">Talks</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/llvm/llvm-project/tree/main/libc">Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/llvm/llvm-project/labels/libc">Bug Reports</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discourse.llvm.org/c/runtimes/libc">Discourse</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.gg/xS7Z362">Join the Discord</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.com/channels/636084430946959380/636732994891284500">Discord Channel</a></li>
<li class="toctree-l1"><a class="reference external" href="https://lab.llvm.org/buildbot/#/builders?tags=libc">Buildbot</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">libc for GPUs</a><ul>
      <li>Previous: <a href="rpc.html" title="previous chapter">Remote Procedure Calls</a></li>
      <li>Next: <a href="motivation.html" title="next chapter">Motivation and Limitations</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2011-2025, LLVM Project.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/gpu/testing.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>